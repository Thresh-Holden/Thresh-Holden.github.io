<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>第14章、集成脚本引擎 - 3D游戏编程与设计 - 中山大学</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="潘茂林" /><meta name="description" content="Don&amp;rsquo;t let the noise of other&amp;rsquo;s opinions drown out your own inner voice. And most important, have the courage to follow your heart and intuition. &amp;mdash; Steve Jobs, Stanford Report, June 14, 2005 课程内容与资源 1、资源下载 sLua 2、相关知识 托管资源、垃圾回收 本节课内容属于游" /><meta name="keywords" content="中山大学, 数据科学与计算机, 3D游戏编程与设计" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="http://Thresh-Holden.github.io/post/14-script-integration/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.32d4dc642fec98c34c80bebb9c784c50771712b4a8a25d9f4dd9cce3534b426e.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="第14章、集成脚本引擎" />
<meta property="og:description" content="Don&rsquo;t let the noise of other&rsquo;s opinions drown out your own inner voice. And most important, have the courage to follow your heart and intuition. &mdash; Steve Jobs, Stanford Report, June 14, 2005 课程内容与资源 1、资源下载 sLua 2、相关知识 托管资源、垃圾回收 本节课内容属于游" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://Thresh-Holden.github.io/post/14-script-integration/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-11-20T00:00:00+08:00" />
<meta property="article:modified_time" content="2020-11-20T00:00:00+08:00" />

<meta itemprop="name" content="第14章、集成脚本引擎">
<meta itemprop="description" content="Don&rsquo;t let the noise of other&rsquo;s opinions drown out your own inner voice. And most important, have the courage to follow your heart and intuition. &mdash; Steve Jobs, Stanford Report, June 14, 2005 课程内容与资源 1、资源下载 sLua 2、相关知识 托管资源、垃圾回收 本节课内容属于游"><meta itemprop="datePublished" content="2020-11-20T00:00:00+08:00" />
<meta itemprop="dateModified" content="2020-11-20T00:00:00+08:00" />
<meta itemprop="wordCount" content="9759">
<meta itemprop="keywords" content="课件," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="第14章、集成脚本引擎"/>
<meta name="twitter:description" content="Don&rsquo;t let the noise of other&rsquo;s opinions drown out your own inner voice. And most important, have the courage to follow your heart and intuition. &mdash; Steve Jobs, Stanford Report, June 14, 2005 课程内容与资源 1、资源下载 sLua 2、相关知识 托管资源、垃圾回收 本节课内容属于游"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">3D游戏编程与设计</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/post/index-2020">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">3D游戏编程与设计</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/post/index-2020">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">第14章、集成脚本引擎</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-11-20 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#课程内容与资源">课程内容与资源</a></li>
        <li><a href="#1脚本引擎技术简介">1、脚本引擎技术简介</a>
          <ul>
            <li><a href="#11-什么是脚本">1.1 什么是脚本？</a></li>
            <li><a href="#12-游戏引擎为什么要嵌入-lua">1.2 游戏引擎为什么要嵌入 Lua？</a></li>
            <li><a href="#13-lua-脚本的能力与缺陷">1.3 Lua 脚本的能力与缺陷</a></li>
          </ul>
        </li>
        <li><a href="#2lua-入门">2、Lua 入门</a>
          <ul>
            <li><a href="#21-lua-world">2.1 lua world！</a></li>
            <li><a href="#22-lua-语言初步">2.2 lua 语言初步</a></li>
          </ul>
        </li>
        <li><a href="#3unity-插件技术与-lua-插件安装">3、Unity 插件技术与 Lua 插件安装</a>
          <ul>
            <li><a href="#31-unity-插件plugin">3.1 Unity 插件（plugin）</a></li>
            <li><a href="#32-lua-动态库编译">3.2 Lua 动态库编译</a></li>
            <li><a href="#33-lua-插件安装">3.3 Lua 插件安装</a></li>
          </ul>
        </li>
        <li><a href="#4lua-虚拟机-与-lua-栈">4、Lua 虚拟机 与 Lua 栈</a>
          <ul>
            <li><a href="#41-lua-应用程序接口">4.1 Lua 应用程序接口</a></li>
            <li><a href="#42-lua-虚拟机">4.2 Lua 虚拟机</a></li>
            <li><a href="#42-lua-栈">4.2 Lua 栈</a></li>
          </ul>
        </li>
        <li><a href="#5-应用host与-lua-虚拟机互操作入门">5、 应用（host）与 Lua 虚拟机互操作入门</a>
          <ul>
            <li><a href="#51-访问-lua-虚拟机的全局变量">5.1 访问 Lua 虚拟机的全局变量</a></li>
            <li><a href="#52-相互调用函数">5.2 相互调用函数</a></li>
            <li><a href="#53-复杂数据的交换">5.3 复杂数据的交换</a></li>
            <li><a href="#54-批量注册宿主的函数">5.4 批量注册宿主的函数</a></li>
          </ul>
        </li>
        <li><a href="#6lua-面向对象编程与互操作">6、lua 面向对象编程与互操作</a>
          <ul>
            <li><a href="#61-元表metatable机制">6.1 元表（MetaTable）机制</a></li>
            <li><a href="#62-lua-面向对象的实现方法">6.2 lua 面向对象的实现方法</a></li>
            <li><a href="#63-访问-unity-中的游戏对象">6.3 访问 unity 中的游戏对象</a></li>
          </ul>
        </li>
        <li><a href="#7lua-集成技术小结">7、Lua 集成技术小结</a></li>
        <li><a href="#8作业与练习">8、作业与练习</a></li>
        <li><a href="#课后参考阅读">课后参考阅读</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <blockquote>
<p><strong><em>Don&rsquo;t let the noise of other&rsquo;s opinions drown out your own inner voice. And most important, have the courage to follow your heart and intuition.</em></strong></p>
<p>&mdash; Steve Jobs, Stanford Report, June 14, 2005</p>
</blockquote>
<h2 id="课程内容与资源">课程内容与资源</h2>
<p><img src="../images/game-architecture-script.png" alt=""></p>
<p><strong>1、资源下载</strong></p>
<p><img src="../images/drf/open_alt.png" alt=""> <a href="https://github.com/pangweiwei/slua">sLua</a></p>
<p><strong>2、相关知识</strong></p>
<ul>
<li><a href="../x3-08-managed-resouce-gc.md">托管资源、垃圾回收</a></li>
</ul>
<p><strong>本节课内容属于游戏高级技术。如果你不打算从事游戏行业，了解即可</strong></p>
<p><em>预计时间：6 * 45 min</em></p>
<h2 id="1脚本引擎技术简介">1、脚本引擎技术简介</h2>
<h3 id="11-什么是脚本">1.1 什么是脚本？</h3>
<p>在计算机领域，脚本又称动态脚本（Dynamic Scprits），一般特指解释执行语言，如 JavaScript, Python，perl，shell 等，脚本语言缩短了传统的编写-编译-链接-运行（edit-compile-link-run）过程，支持交互式编程，特别合适批任务处理、交互式命令控制或数据处理、小规模程序快速编程。</p>
<p>脚本语言通常都有简单、易学、易用的特性，是为非计算机专业人士定制 <strong>领域特定语言（Domain Specific Languages）</strong> 的利器。例如，著名的 Matlab、R 就是科学计算领域专用语言，它获得了计算领域研究人员、工程师的广泛认可。</p>
<h3 id="12-游戏引擎为什么要嵌入-lua">1.2 游戏引擎为什么要嵌入 Lua？</h3>
<p>简单说是 Lua 是一种通用的脚本语言，语法相对简单。 它有一个 c 语言编写的小巧的解释程序，这个程序很容易嵌入宿主（HOST）应用，并能够与宿主程序 <strong>互操作（interoperation）</strong>。所谓互操作，即宿主程序能调用 Lua 写的函数，反之 Lua 程序中也能调用宿主的函数。例如，微信小程序，就是在微信应用中嵌入一个 ECMAScript 的引擎，如 Google V8 或 JavaScriptCore （浏览器内核），然后在微信中开发一组共微信小程序调用的函数访问手机设备与微信内部资源。微信小程序就是脚本，微信应用就是 HOST。因此，微信小程序就是扩展微信应用的定制语言。</p>
<p>Lua，一种简单、高效的语言，一直是各类游戏引擎钟爱的嵌入语言，在移动设备上也有不错的表现，如 cocos2d 官方脚本集成就是 Lua。例如，与 Python 核心代码相比，Python 是 17 万行代码，而 Lua 是 2.4 万行。当然，小也是有代价的，就是没有丰富的语言特性，强大的基础函数库。通过嵌入 Lua ，游戏应用就可以被方便的扩展新功能。</p>
<p><strong>游戏嵌入脚本的作用</strong></p>
<ul>
<li>方便角色行为逻辑设计。数据代码分离不是万能的，在游戏智能中，Agent 的规则推理机、决策树等方案不是普通设计师能理解的，使用简单的编程脚本，非计算机专业业务人员也能做一些简单游戏编程工作</li>
<li>开发一类游戏通用的引擎。开发者专注技术开发，将部分不通用、不太影响性能的游戏逻辑交给脚本实现，可大大提升同类游戏的开发效率（主程就解放了！）</li>
<li><strong>热更新（HotFix）</strong>。在线 <strong>静默</strong> 更新游戏逻辑</li>
</ul>
<p>热更新，就是在线升级游戏，特别是手机游戏。受 IOS 等手机操作系统安全管理的制约，一个应用是没有权利修改任何可执行的代码权利，应用只可读写该应用下数据目录。这样，应用程序的更新就必须经过“App-store发布，用户下载，安装”这个流程，其中App-store发布审批一个环节就需要3-5天。脚本就是一个文本文件，如果问题代码在脚本中，直接从网上下载新版本，客户根本感受不到升级的过程。因此，“热更新”成为手机游戏的 <strong>炙手可热</strong> 的特征。</p>
<h3 id="13-lua-脚本的能力与缺陷">1.3 Lua 脚本的能力与缺陷</h3>
<p>在 Unity 中集成 Lua 引擎，一些 Lua 版本提供了完整游戏的开发能力，即一个游戏完全有 Lua 语言开发，如 SLua。</p>
<p>既然这么好，为什么不直接用 Lua 开发游戏？</p>
<ul>
<li>慢。 假设 c 语言完成一个任务要 1 秒， C#，Java 等则需要 3 到 5 秒， Lua 等脚本语言再慢 10 倍 30 - 50 秒。 游戏是讲究 FPS 的啊！</li>
<li>调试难。 无类型语言很爽，但没有强大的静态语法检查，编译不能给你太多帮助。 大程序直接让你从内心崩溃！</li>
</ul>
<p>集成 lua 的一些游戏产品：</p>
<ul>
<li>大话西游2</li>
<li>魔兽世界Wow</li>
<li>剑侠情缘3</li>
</ul>
<p>因此学习脚本引擎集成技术非常重要！</p>
<ul>
<li>在知乎上搜 “游戏 Lua” 会有更多小伙伴讲授他们的经验和感受！</li>
<li>如果你从此感兴趣于语言设计的秘密，请移步到《编译原理》课程。 Lua 将是该课程最佳实践教材！</li>
</ul>
<h2 id="2lua-入门">2、Lua 入门</h2>
<p>如果你有 c 语言和 javascript 基础（自我检查，它们的函数闭包 <a href="https://en.wikipedia.org/wiki/Closure_(computer_programming)">closures</a> 怎么用？）, 建议你忽略本部分内容， 到维基百科了解 lua 语法即可。</p>
<h3 id="21-lua-world">2.1 lua world！</h3>
<p><img src="../images/drf/movies.png" alt=""> 操作 14-01，Lua入门练习：</p>
<p>进入 Lua 语言 <a href="http://www.lua.org/demo.html">在线执行器</a></p>
<p>输入 <code>print (&quot;hello world!&quot;)</code> 然后按 run 按钮</p>
<h3 id="22-lua-语言初步">2.2 lua 语言初步</h3>
<p>我们已假设你熟悉 C/C++ 或 javascript 语言，因而在线 <a href="https://www.lua.org/manual/5.1/">参考手册</a> 比较合适你阅读。</p>
<p>在手册第二章，你需要阅读：</p>
<ul>
<li>语法习惯（Lexical Conventions）：包括 关键词、操作符、字串与数字的表示</li>
<li>值与类型（Values and Types）
<ul>
<li>lua 值是第一类成员（<em>first-class values</em>），它们可以存到变量中，作为函数参数。</li>
<li>有 8 种类型的值：<em>nil, boolean, number, string, function, userdata, thread, table</em></li>
</ul>
</li>
</ul>
<p><strong>值是第一类成员</strong> 是动态类型脚本语言的核心概念，等你理解了它的含义，脚本语言就过关了！以 function 类型值为例，它看作第一类成员，所以可以作为变量值、作为函数参数、参与运算等等。</p>
<ul>
<li>面向对象语言，如java，核心 <em>first-class objects</em></li>
<li>函数式语言包括 go 等核心 <em>first-class functions</em></li>
</ul>
<p>以下一些代码能帮你理解一些基本的 Lua 语法</p>
<p><strong>1、赋值</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="n">a</span> <span class="o">=</span> <span class="p">{}</span>                 <span class="c1">-- construct a global table a</span>
</span></span><span class="line"><span class="cl"><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl"><span class="n">print</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>结果是 <code>4       nil	20</code>。因为，左边先解释得到地址，后计算值，因此不会影响 <code>a[4]</code></p>
<p><strong>2、函数定义</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kr">function</span> <span class="nf">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="n">factorial</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>这段代码展示了它的函数定义、局部变量定义、控制语句等。具体有哪些控制结构，参见手册！</p>
<ul>
<li>建议课后继续阅读 <a href="http://www.runoob.com/lua/lua-tutorial.html">lua 菜鸟教程</a></li>
</ul>
<h2 id="3unity-插件技术与-lua-插件安装">3、Unity 插件技术与 Lua 插件安装</h2>
<p>插件是扩展 Unity 能力的利器。AR，或你编写的优化算法都必须通过插件的方式供 Unity 使用。</p>
<h3 id="31-unity-插件plugin">3.1 Unity 插件（plugin）</h3>
<p>Unity 支持两种插件，<a href="https://docs.unity3d.com/Manual/Plugins.html">官网文档</a>：</p>
<ul>
<li>Managed plugin: 是使用 Visual Studio 等工具创建的托管 .NET 程序集。它们仅包含 .NET 代码，这意味着它们无法访问 .NET 库不支持的任何功能。但是，Unity使用的标准 .NET 工具可以访问托管代码来编译脚本。因此，托管插件代码和 Unity 脚本代码之间的使用差异很小，除了插件是在 Unity 外部编译，且可能没有源代码。</li>
<li>Native: 是特定机器硬件与操作系统平台的本机代码库。他们可以访问操作系统调用和第三方代码库等功能，否则 Unity 将无法使用这些功能。但是，Unity 的工具无法以托管库的方式访问这些库。常指 C/C++ 类 C 语言编译的动态库（.dll, .so）</li>
</ul>
<h3 id="32-lua-动态库编译">3.2 Lua 动态库编译</h3>
<p>如果你有 苹果 Mac 或 Linux PC， 可参照 SLua 的 make。 强力建议你自己 make 各个平台的库。</p>
<h3 id="33-lua-插件安装">3.3 Lua 插件安装</h3>
<p><img src="../images/drf/movies.png" alt=""> 操作 14-02，插件部署练习：</p>
<p>SLua 已编译的版本是 Lua 5.1.5，</p>
<p>1、下载 SLua 解压。主要目的是免去各平台下编译的烦恼，以及一些可供学习的原代码<br>
2、创建一个新项目 lua<br>
3、在 Assets 下创建目录 <code>Plugins</code> <strong>注意 Plugins 大小写</strong>！</p>
<p>注意：各平台插件原生代码默认目录 <a href="https://docs.unity3d.com/Manual/PluginInspector.html">Plugin Inspector</a> Setting!</p>
<p>4、加载平台本地动态库</p>
<p>将编译好的动态库（dll,so），从 SLua 对应目录拖入 Plugins。例如开发平台 64 位 window，则拖入 x64。</p>
<p>未来，你编译哪个平台，就加载哪个平台库。</p>
<p>5、加载 lua 与 c# 的接口库</p>
<p>在 Plugins 目录下建立目录 managed；</p>
<p>从 Slua -&gt; Plugins -&gt; Slua_Managed 中拖 LuaDLL.cs 和 LuaDLLWrapper.cs 进入 managed。导入 c 语言库，让 Unity 访问。</p>
<p>6、OK！ 运行，不应该出现任何错误。</p>
<p><strong>不出错非常重要</strong>！不闪退就好啊。下面我们进一步验证安装。</p>
<h2 id="4lua-虚拟机-与-lua-栈">4、Lua 虚拟机 与 Lua 栈</h2>
<h3 id="41-lua-应用程序接口">4.1 Lua 应用程序接口</h3>
<p>Lua 既可以作为独立应用，但多数情况下会嵌入其他应用，如游戏、Nginx 或 其他应用，方便动态扩展业务功能，提升应用的灵活性。</p>
<p><a href="http://www.lua.org/manual/5.3/">Lua 手册</a> ！ 的最后给出了 lua 语言标准库 和 与应用程序接口 C API。</p>
<ul>
<li>语言标准库包括： <em>basic, math, string, io, coroutine, os, debug, package</em></li>
<li>C API 包括： C API, auxiliary library</li>
<li>环境变量与常数</li>
</ul>
<h3 id="42-lua-虚拟机">4.2 Lua 虚拟机</h3>
<p><strong>Lua 虚拟机</strong> 即一个 Lua 脚本程序的执行环境 或 沙箱。它由 <code>lua_newstate</code> 创建。</p>
<p>每个线程 <strong>只能有一个 Lua 虚拟机</strong>。因此，仅有且只有第一个 Lua 虚拟机在 <strong>程序主线程</strong> 中，可以访问 Unity 的游戏对象。</p>
<p><img src="../images/drf/exclamation.png" alt="">  <strong>Unity 不支持除主线程以外的线程访问游戏对象</strong>，或与渲染相关的任何对象。当然，值类型、JsonUtility 通常是线程安全的</p>
<p><img src="../images/drf/exclamation.png" alt=""> 不同虚拟机之间是相互隔离的。因此，一个游戏一般仅需要一个 lua 虚拟机实例。</p>
<h3 id="42-lua-栈">4.2 Lua 栈</h3>
<p>每个虚拟机都有一个与应用程序交换数据的栈。这个栈默认有 <strong>20 个元素</strong>。应用程序必须保证栈的安全、正确使用。</p>
<p>Lua 每个 api 都有一个标志，[-o, +p, x] 表示 [ 出栈参数个数，入栈结果个数，是否返回异常] 。例如：:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">lua_getglobal         [-0, +1, e]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">int lua_getglobal (lua_State *L, const char *name);
</span></span><span class="line"><span class="cl">Pushes onto the stack the value of the global name. Returns the type of that value
</span></span></code></pre></td></tr></table>
</div>
</div><p>分别表示调用该 API ，没有元素出栈，有一个结果元素入栈，会有异常。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">lua_tointeger          [-0, +0, –]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">lua_Integer lua_tointeger (lua_State *L, int index);
</span></span><span class="line"><span class="cl">Equivalent to lua_tointegerx with isnum equal to NULL.
</span></span></code></pre></td></tr></table>
</div>
</div><p>api 中 index 参数表示数据在栈中位置，index 为负数，如 -1 表示栈顶，-2，-3 类推；<br>
index 为正数，表示位置， 如 1 是栈底，2，3 类推；<br>
lua_gettop 返回当前栈的高度；0 表示 空栈。</p>
<h2 id="5-应用host与-lua-虚拟机互操作入门">5、 应用（host）与 Lua 虚拟机互操作入门</h2>
<p>这部分讲述如何利用虚拟机的栈，实现 应用程序 与 lua 之间数据交换和函数调用。</p>
<h3 id="51-访问-lua-虚拟机的全局变量">5.1 访问 Lua 虚拟机的全局变量</h3>
<p><img src="../images/drf/movies.png" alt=""> 操作 14-03，读写 lua 变量练习：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">SLua</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">class</span> <span class="nc">my</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Use this for initialization</span>
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">Start</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">IntPtr</span> <span class="n">_L</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">luaL_newstate</span> <span class="p">();</span>    <span class="c1">// create a lua VM</span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">luaL_openlibs</span><span class="p">(</span><span class="n">_L</span><span class="p">);</span>               <span class="c1">// open lua libs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_dostring</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span><span class="s">&#34;num = 3&#34;</span><span class="p">);</span>     <span class="c1">// Excute a simple lua Script</span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_getglobal</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="s">&#34;num&#34;</span><span class="p">);</span>       <span class="c1">// push the lua var named ‘num’ on the stack</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_tointeger</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>  <span class="c1">// read return value on the top of stack</span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pop</span><span class="p">(</span><span class="n">_L</span><span class="p">,</span><span class="m">1</span><span class="p">)</span> <span class="p">;</span>                  <span class="c1">// pop, your must maintain the stack carefully!!!</span>
</span></span><span class="line"><span class="cl">                <span class="n">Debug</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//this.transform.position = new Vector3 (0, i, 0);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_close</span> <span class="p">(</span><span class="n">_L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个程序非常简单，第一步创建虚拟机；然后执行简单赋值，然后把变量结果通过栈传给应用；关闭虚拟机。</p>
<p><img src="../images/drf/exclamation.png" alt=""> 错误操作特容易产生闪退，请及时保存程序！！</p>
<p><img src="../images/drf/ichat.png" alt="">  解释以下代码？栈有错误吗？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushinteger</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="m">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_setglobal</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="s">&#34;a&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushinteger</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="m">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_setglobal</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="s">&#34;b&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_dostring</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span><span class="s">&#34;c = a+b&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_getglobal</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="s">&#34;c&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Debug</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_tointeger</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pop</span><span class="p">(</span><span class="n">_L</span><span class="p">,</span><span class="m">1</span><span class="p">)</span> <span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>lua_setglobal</code> ，请翻译<a href="http://www.lua.org/manual/5.1/manual.html#lua_setglobal">手册描述</a>，并解释 API 栈行为！</p>
<h3 id="52-相互调用函数">5.2 相互调用函数</h3>
<p><img src="../images/drf/movies.png" alt=""> 操作 14-04，相互调用函数练习：</p>
<p>该段代码第一部分是 HOST 调用 Luau 虚拟机中的 <code>foo (x,y)</code>，然后，Lua 程序调用 HOST 的 <code>dofile(&quot;luafile.lua&quot;)</code> 函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine.UI</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">SLua</span><span class="p">;</span>    <span class="c1">//using LuaInterface;   // lua DLL C# 封装</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">class</span> <span class="nc">Lua_func</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">public</span> <span class="n">GameObject</span> <span class="n">text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Use this for initialization</span>
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">Start</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Text</span> <span class="n">txt</span> <span class="p">=</span> <span class="n">text</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Text</span><span class="p">&gt;</span> <span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// Create Lua State</span>
</span></span><span class="line"><span class="cl">                <span class="n">IntPtr</span> <span class="n">_L</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">luaL_newstate</span> <span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">luaL_openlibs</span><span class="p">(</span><span class="n">_L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// define lua fuction</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">func</span> <span class="p">=</span> <span class="s">@&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">function foo (x,y)
</span></span></span><span class="line"><span class="cl"><span class="s">        return x+y
</span></span></span><span class="line"><span class="cl"><span class="s">end
</span></span></span><span class="line"><span class="cl"><span class="s">                &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_dostring</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span><span class="n">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// call lua fuction</span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_getglobal</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="s">&#34;foo&#34;</span><span class="p">);</span>               <span class="c1">// push the lua function var on the stack</span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushnumber</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="m">6</span><span class="p">);</span>                  <span class="c1">// push paramters on the stack</span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushnumber</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="m">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// http://www.lua.org/manual/5.1/manual.html#lua_call</span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_call</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>                     <span class="c1">//call foo with two parameter on Stack. [-(nargs+1), +nresults, e]</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// get result</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_tointeger</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pop</span><span class="p">(</span><span class="n">_L</span><span class="p">,</span><span class="m">1</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">txt</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// define cFunction in Lua machine，and then call it </span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushcfunction</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="n">dofile</span><span class="p">);</span>  <span class="c1">// set LuaCSFunction</span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_setglobal</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="s">&#34;dofile&#34;</span><span class="p">);</span>    <span class="c1">// assign to &#34;dofile&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_dostring</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="s">&#34;dofile(\&#34;tail.lua\&#34;)&#34;</span><span class="p">);</span>       <span class="c1">//call dofile(_L) in c#</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_close</span> <span class="p">(</span><span class="n">_L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// lua dofile(&#34;luafile.lua&#34;) callback handler, must static</span>
</span></span><span class="line"><span class="cl"><span class="na">        [MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]</span>
</span></span><span class="line"><span class="cl">        <span class="k">internal</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">dofile</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">L</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">n</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_gettop</span> <span class="p">(</span><span class="n">L</span><span class="p">);</span>          <span class="c1">// number of arguments</span>
</span></span><span class="line"><span class="cl">                <span class="n">Debug</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">Log</span> <span class="p">(</span><span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">string</span> <span class="n">fileName</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span> <span class="c1">// index +/positive</span>
</span></span><span class="line"><span class="cl">                <span class="n">Debug</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">Log</span> <span class="p">(</span><span class="n">fileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="m">0</span><span class="p">;</span>                                                       <span class="c1">// number of results</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>创建 Lua_func.cs 程序</li>
<li>在场景中放置 text UI 游戏对象</li>
<li>挂入代码，将 text 对象拖入插槽</li>
<li>run！</li>
</ul>
<p>应用程序调用 Lua 定义的函数非常简单，将函数 *<strong>参数的值</strong> 压入栈底，压入参数，然后 lua_call, 然后从栈顶取回 <strong>返回值</strong> 即可！</p>
<p>从 Lua 调用 c# 的函数就不那么简单了。</p>
<ul>
<li>设置函数变量</li>
<li>调用 C 函数</li>
</ul>
<p><a href="http://www.lua.org/manual/5.1/manual.html#lua_CFunction">Lua 官方手册</a> 给出了 CFunction 的通讯协议</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">lua_CFunction</span><span class="p">)</span> <span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>协议规定，Lua 函数参数按左到右，正方向压入栈。即 C 语言从 栈的 1，2，3 &hellip; 位置读参数，API lua_gettop(L) 是参数的个数。 返回结果给 Lua 按接收顺序压入堆栈，返回值是参数的个数。</p>
<p><img src="../images/drf/ichat.png" alt="">  以下是 C 的函数，请翻译成 C# 并调用该函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">foo</span> <span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">lua_gettop</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>    <span class="cm">/* number of arguments */</span>
</span></span><span class="line"><span class="cl">  <span class="n">lua_Number</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lua_isnumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">lua_pushstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;incorrect argument&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">lua_error</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="n">sum</span> <span class="o">+=</span> <span class="n">lua_tonumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">lua_pushnumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">sum</span><span class="o">/</span><span class="n">n</span><span class="p">);</span>        <span class="cm">/* first result */</span>
</span></span><span class="line"><span class="cl">  <span class="n">lua_pushnumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">sum</span><span class="p">);</span>         <span class="cm">/* second result */</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>                   <span class="cm">/* number of results */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>如果 Lua 回调函数中存在异步加载、或继续调用 Lua 虚拟机？ 晕了，难以想象！</li>
<li>为什么必须使用 MonoPInvokeCallbackAttribute 呢？自己搜索！</li>
</ul>
<h3 id="53-复杂数据的交换">5.3 复杂数据的交换</h3>
<p>简单数据交换很方便，但是 C# 有 命名空间、类、结构、数字、字典等。Lua 有 函数 与万能的 table，它们是如何建立对应关系的呢？</p>
<p>数据交换，必须了解 lua_[push|to|is][*] 系列 API 函数。 例如： lua_pushnumber 将 c 语言 double 值压入栈成为 lua 认识的 number。 Lua 常见类型值：boolean，number，string，nil, none, cfunction, function, &hellip; 都可以处理。</p>
<p><strong>1、Lua 表</strong></p>
<p>如果你熟悉 javascript , lua 表和 javascript 表概念是没有区别的。javascript 每个实例有一个根表 <code>window</code> 而 Lua 是 <code>_G</code> 罢了。</p>
<p>例如: 在 javascript 中 <code>window.x = 3</code>、<code>x = 3</code> 与 <code>window[&quot;x&quot;]=3</code> 都是同样语义。</p>
<p>表就是一个 key-value 对集合的数据结构（字典）。表用 key 索引访问，索引一般是字符串或整数。虽然可以号称任意对象做索引，似乎也没有太多的必要。</p>
<p><img src="../images/drf/movies.png" alt=""> 操作 14-04，复杂数据练习：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="n">point</span> <span class="o">=</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">20</span> <span class="p">}</span>   <span class="c1">-- Create new table</span>
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="s2">&#34;x&#34;</span><span class="p">])</span>            <span class="c1">-- Prints 10</span>
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="n">point.x</span><span class="p">)</span>               <span class="c1">-- Has exactly the same meaning as line above. The easier-to-read</span>
</span></span><span class="line"><span class="cl">                             <span class="c1">--     dot notation is just syntactic sugar.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中，<code>{...}</code> 表示表，是一个字典。dot 符号称为“语法糖”，让人类读起来舒服一些，易于理解一些。</p>
<p>让案例再复杂点:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="n">point</span> <span class="o">=</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">20</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;string1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;string2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">point</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;string5&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">point</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="n">point</span><span class="p">[</span><span class="n">point</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">40</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">point</span><span class="p">[</span><span class="s2">&#34;x&#34;</span><span class="p">],</span><span class="o">#</span><span class="n">point</span><span class="p">,</span><span class="n">point</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">point</span><span class="p">,</span><span class="n">point</span><span class="p">[</span><span class="n">point</span><span class="p">].</span><span class="n">x</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>输出是:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">string2 10      2       nil     table: 0x15f1f10        30
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中，# 操作符是计算数组的大小。 为什么不是 5 是 2 呢 ？</p>
<p>在 lua 执行器运行以下代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="n">point</span> <span class="o">=</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">20</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;string1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;string2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">point</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;string5&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">point</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="n">point</span><span class="p">[</span><span class="n">point</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">40</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">point</span><span class="p">[</span><span class="s2">&#34;x&#34;</span><span class="p">],</span><span class="o">#</span><span class="n">point</span><span class="p">,</span><span class="n">point</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">point</span><span class="p">,</span><span class="n">point</span><span class="p">[</span><span class="n">point</span><span class="p">].</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="kr">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="p">(</span><span class="n">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">~=</span> <span class="s2">&#34;table&#34;</span><span class="p">)</span> <span class="kr">then</span> <span class="n">print</span> <span class="p">(</span><span class="s2">&#34;pair:&#34;</span><span class="o">..</span><span class="n">i</span><span class="o">..</span><span class="s2">&#34; = &#34;</span><span class="o">..</span><span class="n">v</span><span class="p">)</span> <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="p">(</span><span class="n">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">~=</span> <span class="s2">&#34;table&#34;</span><span class="p">)</span> <span class="kr">then</span> <span class="n">print</span> <span class="p">(</span><span class="s2">&#34;ipair:&#34;</span><span class="o">..</span><span class="n">i</span><span class="o">..</span><span class="s2">&#34; = &#34;</span><span class="o">..</span><span class="n">v</span><span class="p">)</span> <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中 <code>..</code> 表示字符 cat 操作；pairs 是内置迭代函数。 pairs 迭代表中所有元素对， ipair 迭代从 1 开始连续的整数 key。 <code>#</code> 表示有 1，2 两个元素。</p>
<p>其实，这样赋值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="n">point</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;string1&#34;</span><span class="p">,</span><span class="s2">&#34;string2&#34;</span><span class="p">,</span><span class="kc">nil</span><span class="p">,</span><span class="n">x</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span><span class="kc">nil</span><span class="p">,</span><span class="s2">&#34;string5&#34;</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>输出也一样。</p>
<p>在 Lua demo 有一个 dump 全局变量的 lua 案例程序 globals， lua 代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- globals.lua</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- show all global variables</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">seen</span><span class="o">=</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nf">dump</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">seen</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">=</span><span class="kc">true</span>
</span></span><span class="line"><span class="cl">	<span class="kd">local</span> <span class="n">s</span><span class="o">=</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="kd">local</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="kr">for</span> <span class="n">k</span> <span class="kr">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">		<span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span> <span class="n">s</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">=</span><span class="n">k</span>
</span></span><span class="line"><span class="cl">	<span class="kr">end</span>
</span></span><span class="line"><span class="cl">	<span class="n">table.sort</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="kr">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">		<span class="n">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">v</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="kr">if</span> <span class="n">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">==</span><span class="s2">&#34;table&#34;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">seen</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">			<span class="n">dump</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">i</span><span class="o">..</span><span class="s2">&#34;</span><span class="se">\t</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="kr">end</span>
</span></span><span class="line"><span class="cl">	<span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dump</span><span class="p">(</span><span class="n">_G</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>2、结构（记录）、数组的交换</strong></p>
<p>Lua 应用程序 API 提供以下函数满足交换的要求。因为栈就只有 20 个单元，不可能把所有数据压上。数据处理过程如下:</p>
<p>假设栈内 index 位置元素是一个表（指针指向表）, 常用 API 有 lua_getglobal, lua_createtable；判断 lua_istable
读表的方法 lua_getTable, 写表就是 lua_settable</p>
<p>下边的代码就是我们读一个 points 数组到 c#</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="k">void</span> <span class="n">Start</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Create Lua State</span>
</span></span><span class="line"><span class="cl">        <span class="n">IntPtr</span> <span class="n">_L</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">luaL_newstate</span> <span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">LuaDLL</span><span class="p">.</span><span class="n">luaL_openlibs</span><span class="p">(</span><span class="n">_L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//read vector[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">luaStr</span> <span class="p">=</span> <span class="s">@&#34;_g = { {x=1,y=2},{x=3,y=4},{x=5,y=6} }&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_dostring</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="n">luaStr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_getglobal</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="s">&#34;_g&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">index</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_gettop</span> <span class="p">(</span><span class="n">_L</span><span class="p">);</span>   <span class="c1">// index of the table on the stack</span>
</span></span><span class="line"><span class="cl">        <span class="n">Debug</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">Log</span> <span class="p">(</span><span class="s">&#34;index = &#34;</span> <span class="p">+</span> <span class="n">index</span><span class="p">.</span><span class="n">ToString</span> <span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>  <span class="n">i</span> <span class="p">&lt;</span> <span class="m">3</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushinteger</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="n">i</span><span class="p">+</span><span class="m">1</span><span class="p">);</span>           <span class="c1">// idx of array _g</span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_gettable</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>            <span class="c1">// get _g[idx] [-1, +1, e] on the top</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">vind</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_gettop</span> <span class="p">(</span><span class="n">_L</span><span class="p">);</span>          <span class="c1">// index of the sub table on the stack</span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushstring</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="s">&#34;x&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_gettable</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="n">vind</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">v2</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span> <span class="p">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_tonumber</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushstring</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="s">&#34;y&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_gettable</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="n">vind</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">v2</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span> <span class="p">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_tonumber</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Debug</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">Log</span> <span class="p">(</span><span class="s">&#34;vec y = &#34;</span> <span class="p">+</span> <span class="n">v2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="p">.</span><span class="n">ToString</span> <span class="p">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pop</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="m">3</span><span class="p">);</span>                                 <span class="c1">// why pop(3)?</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pop</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_close</span> <span class="p">(</span><span class="n">_L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="../images/drf/ichat.png" alt=""> 写一段程序，将一个 Vecter3 写到 Lua 中。</p>
<h3 id="54-批量注册宿主的函数">5.4 批量注册宿主的函数</h3>
<p><strong>1、c# 委托与 c 函数指针</strong></p>
<p>Lua 只有 C 接口，那么 C# 的安全的“指针”，如何转为 c 的函数指针呢？  让我们分析 luaDLL.cs 的函数  lua_pushcfunction 的原代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">lua_pushcfunction</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">luaState</span><span class="p">,</span> <span class="n">LuaCSFunction</span> <span class="n">function</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">IntPtr</span> <span class="n">fn</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="n">GetFunctionPointerForDelegate</span><span class="p">(</span><span class="n">function</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">lua_pushcclosure</span><span class="p">(</span><span class="n">luaState</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">[DllImport(LUADLL, CallingConvention = CallingConvention.Cdecl)]</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="k">void</span> <span class="n">lua_pushcclosure</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">l</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nup</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Marshal 类解包得到非托管的函数指针。MSDN 描述是“提供了一个方法集合，这些方法用于分配非托管内存、复制非托管内存块、将托管类型转换为非托管类型，此外还提供了在与非托管代码交互时使用的其他杂项方法” [。 可见，当我们享受托管带来的编程便利时，似乎忘记了底层关键技术，然而，要让 Lua 与 Unity 无缝交互，你需要知道语言的执行机理、编译技术、复杂的指针转换 &hellip;</p>
<p><strong>Marshal 实现的托管对象 与 IntPtr 转换</strong>：</p>
<ul>
<li>委托 与 函数指针
<ul>
<li>GetFunctionPointerForDelegate</li>
<li>GetDelegateForFunctionPointer</li>
</ul>
</li>
<li>结构值（值类型） 与 非托管内存（* byte[]）
<ul>
<li>StructureToPtr</li>
<li>PtrToStructure</li>
<li>SizeOf</li>
</ul>
</li>
</ul>
<p><strong>2、批量注入 c# 函数</strong></p>
<p>lua 只能调用静态的函数，以下代码展示了如何利用表注册一批 C# 函数供 lua 使用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">SLua</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">class</span> <span class="nc">lua_register</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Use this for initialization</span>
</span></span><span class="line"><span class="cl">	<span class="k">void</span> <span class="n">Start</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Create Lua State</span>
</span></span><span class="line"><span class="cl">		<span class="n">IntPtr</span> <span class="n">_L</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">luaL_newstate</span> <span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">luaL_openlibs</span><span class="p">(</span><span class="n">_L</span><span class="p">);</span>	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">lua_register</span><span class="p">.</span><span class="n">RegisterLib</span><span class="p">(</span><span class="n">_L</span><span class="p">,</span><span class="s">&#34;my_math&#34;</span><span class="p">,</span> <span class="n">mathlib</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_dostring</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="s">@&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">a = my_math.my_cos(1)
</span></span></span><span class="line"><span class="cl"><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_getglobal</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="s">&#34;a&#34;</span><span class="p">);</span>       <span class="c1">// push the lua var named ‘num’ on the stack</span>
</span></span><span class="line"><span class="cl">		<span class="kt">double</span> <span class="n">ff</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_tonumber</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>  <span class="c1">// read return value on the top of stack</span>
</span></span><span class="line"><span class="cl">		<span class="n">print</span><span class="p">(</span> <span class="s">&#34;watch output = &#34;</span> <span class="p">+</span> <span class="n">ff</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pop</span><span class="p">(</span><span class="n">_L</span><span class="p">,</span><span class="m">1</span><span class="p">)</span> <span class="p">;</span>                  <span class="c1">// pop, your must maintain the stack carefully!!!</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Close Lua State</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_close</span> <span class="p">(</span><span class="n">_L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">RegisterLib</span> <span class="p">(</span><span class="n">IntPtr</span> <span class="n">luaState</span><span class="p">,</span> <span class="kt">string</span> <span class="n">libName</span><span class="p">,</span> <span class="n">LuaL_Reg</span><span class="p">[]</span> <span class="n">lib</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_newtable</span> <span class="p">(</span><span class="n">luaState</span><span class="p">);</span>  			<span class="c1">// Creates a new empty table and pushes it onto the stack. It is equivalent to lua_createtable(L, 0, 0).</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">tableIdx</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_gettop</span><span class="p">(</span><span class="n">luaState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">foreach</span> <span class="p">(</span><span class="n">LuaL_Reg</span> <span class="n">reg</span> <span class="k">in</span> <span class="n">mathlib</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushstring</span> <span class="p">(</span><span class="n">luaState</span><span class="p">,</span> <span class="n">reg</span><span class="p">.</span><span class="n">funcName</span><span class="p">);</span>     <span class="c1">// set k</span>
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushcfunction</span> <span class="p">(</span><span class="n">luaState</span><span class="p">,</span> <span class="n">reg</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>   	<span class="c1">// set v = LuaCSFunction</span>
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_settable</span><span class="p">(</span><span class="n">luaState</span><span class="p">,</span> <span class="n">tableIdx</span><span class="p">);</span>			<span class="c1">// index of table on the stack</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_setglobal</span> <span class="p">(</span><span class="n">luaState</span><span class="p">,</span> <span class="n">libName</span><span class="p">);</span>	<span class="c1">// set to table</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">	[MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">my_math_sin</span> <span class="p">(</span><span class="n">IntPtr</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushnumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">Math</span><span class="p">.</span><span class="n">Sin</span><span class="p">(</span><span class="n">LuaDLL</span><span class="p">.</span><span class="n">luaL_checknumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="m">1</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">	[MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">my_math_cos</span> <span class="p">(</span><span class="n">IntPtr</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushnumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">Math</span><span class="p">.</span><span class="n">Cos</span><span class="p">(</span><span class="n">LuaDLL</span><span class="p">.</span><span class="n">luaL_checknumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="m">1</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">static</span> <span class="n">LuaL_Reg</span><span class="p">[]</span> <span class="n">mathlib</span> <span class="p">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">new</span> <span class="n">LuaL_Reg</span> <span class="p">(</span> <span class="s">&#34;my_cos&#34;</span><span class="p">,</span>   <span class="n">my_math_cos</span> <span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="k">new</span> <span class="n">LuaL_Reg</span> <span class="p">(</span> <span class="s">&#34;my_sin&#34;</span><span class="p">,</span>   <span class="n">my_math_sin</span> <span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">struct</span> <span class="nc">LuaL_Reg</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="kt">string</span> <span class="n">funcName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="n">LuaCSFunction</span> <span class="n">func</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="n">LuaL_Reg</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">LuaCSFunction</span> <span class="n">f</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">funcName</span> <span class="p">=</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">func</span> <span class="p">=</span> <span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>  
</span></span></code></pre></td></tr></table>
</div>
</div><p>程序要点：</p>
<ul>
<li>RegisterLib 创建一个表作为命名空间，将 C# 函数作为该表的成员函数</li>
<li>编写合格的静态函数，处理 lua 函数使用的调用栈，如 my_math_sin</li>
</ul>
<h2 id="6lua-面向对象编程与互操作">6、lua 面向对象编程与互操作</h2>
<p>Lua 没有类的概念，但可以使用 MetaTable 的特性实现面向对象编程。 它类似 JavaScript 的 ProtoType 机制，加上一些语法糖来方便表示面向对象的概念。</p>
<p>由于 Lua 和 C# 都是带有自动垃圾回收机制的语言，仔细管理对象的生命周期。这几乎是 C# 与 Lua 对象交互编程的噩梦，不小心就会导致非法引用或内存泄漏。 C# 是安全的托管语言， 这导致与 Lua 互操作的复杂性。如值类型（如结构）与引用类型（如对象）指针获取的差异。</p>
<h3 id="61-元表metatable机制">6.1 元表（MetaTable）机制</h3>
<p>Lua 中给个值可以有一个元表。 元表就是一个普通的Lua表，它定义了原始值某些特定操作行为。 例如，当非数字值进行加法操作，如果元表中有一个 <code>__add</code> 的函数，则会调用该函数。</p>
<p>如果访问值类型没有的字段或函数，则会触发事件，交给对应元表执行。</p>
<p>元函数：元表 <code>__XXX</code> 形式命名的函数成员是元函数。常用元函数包括：</p>
<ul>
<li><code>__index</code> 当访问值中不存在的成员时调用；</li>
<li><code>__newindex</code> 当设置值中不存在的成员时调用；</li>
<li><code>__add</code> 当操作值的 <code>+</code> 操作时调用；</li>
<li>其他运算，详见官方手册 metetable</li>
</ul>
<p>使用 <code>getmetatable </code> 函数可以获得一个值的元表；<br>
使用 <code>setmetatable </code> 函数你智能改变表类型的元表。 在 lua 中你不能改变其他类型的元表，除非你使用 C API。</p>
<p>除了 表 和 userdata 具有单独的元表（尽管多个表和userdata可以共享元表），所有其他类型的值每种类型共享一个 metatable; 也就是说，所有数字只有一个 metatable，用于处理 toString 等操作。</p>
<p>对于一个对象（值），我们可以定义它的方法（成员函数）在元表中。利用语法糖 <code>:</code> 定义方法，<code>function table:func(args)</code> 它等价于 <code>function table.func(self, args)</code>。 使用该方法时 <code>object:func(args)</code> 实际调用是 <code> object.func(object, args)</code></p>
<h3 id="62-lua-面向对象的实现方法">6.2 lua 面向对象的实现方法</h3>
<p><img src="../images/drf/movies.png" alt=""> 操作 14-05，lua 对象练习：</p>
<p>创建一个 vector 对象（值），它有元表 Vector，具体 Lua 代码是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">Vector</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="n">Vector.__index</span> <span class="o">=</span> <span class="n">Vector</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">Vector</span><span class="p">:</span><span class="nf">new</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>    <span class="c1">-- The constructor</span>
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">setmetatable</span><span class="p">({</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="p">},</span> <span class="n">Vector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nc">Vector</span><span class="p">:</span><span class="nf">magnitude</span><span class="p">()</span>     <span class="c1">-- Another method</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- Reference the implicit object using self</span>
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">math.sqrt</span><span class="p">(</span><span class="n">self.x</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">self.y</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">self.z</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span>  <span class="c1">--self is the vector not Vector</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">vec</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">:</span><span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">-- Create a vector</span>
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="n">vec</span><span class="p">:</span><span class="n">magnitude</span><span class="p">())</span>          <span class="c1">-- Call a method (output: 1)</span>
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="n">vec.x</span><span class="p">)</span>                    <span class="c1">-- Access a member variable (output: 0)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="../images/drf/exclamation.png" alt=""> <strong>vector 和 Vector 都是普通表！</strong> ，当多个值的元表共享 Vector 时， Vector 就产生了类定义的效果。</p>
<p><img src="../images/drf/ichat.png" alt=""> 修改以上代码，说明错误的原因。</p>
<ul>
<li>注释第二句 <code>--Vector.__index = Vector</code> ，有错误吗？ why？</li>
<li>在后面添加以下代码，会有期望的结果吗？ 如何改？</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">x</span> <span class="o">=</span> <span class="n">vec.new</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="n">x.magnitude</span><span class="p">())</span>  
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="63-访问-unity-中的游戏对象">6.3 访问 unity 中的游戏对象</h3>
<p>这里我们以游戏对象的访问，研究 lua 如何与面向对象语言互操作。以下代码展示了用 Lua 的 userdata 类型值指定一个 metatable，实现 lua 中操纵游戏面向的方法，具体 C# 代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Runtime.InteropServices</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">SLua</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">class</span> <span class="nc">AccessGameObject</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Use this for initialization</span>
</span></span><span class="line"><span class="cl">	<span class="k">void</span> <span class="n">Start</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">IntPtr</span> <span class="n">_L</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">luaL_newstate</span> <span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">luaL_openlibs</span><span class="p">(</span><span class="n">_L</span><span class="p">);</span>	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">RegisterGameObject</span> <span class="p">(</span><span class="n">_L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_dostring</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="s">@&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">a = GameObject.Find(&#39;Cube&#39;)
</span></span></span><span class="line"><span class="cl"><span class="s">-- GameObject.__index = GameObject
</span></span></span><span class="line"><span class="cl"><span class="s">a:Move(3,4,0)
</span></span></span><span class="line"><span class="cl"><span class="s">b = a.name
</span></span></span><span class="line"><span class="cl"><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_getglobal</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="s">&#34;b&#34;</span><span class="p">);</span>       <span class="c1">// push the lua var on the stack</span>
</span></span><span class="line"><span class="cl">		<span class="n">print</span><span class="p">(</span><span class="s">&#34; watch trieved attribution name = &#34;</span><span class="p">+</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_tostring</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">));</span>  <span class="c1">// read return value</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pop</span><span class="p">(</span><span class="n">_L</span><span class="p">,</span><span class="m">1</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_close</span> <span class="p">(</span><span class="n">_L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">RegisterGameObject</span> <span class="p">(</span><span class="n">IntPtr</span> <span class="n">luaState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">luaL_newmetatable</span> <span class="p">(</span><span class="n">luaState</span><span class="p">,</span> <span class="s">&#34;GameObject&#34;</span><span class="p">);</span>  	<span class="c1">//.Only metatable can be set to userdate</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">tableIdx</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_gettop</span><span class="p">(</span><span class="n">luaState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">foreach</span> <span class="p">(</span><span class="n">LuaL_Reg</span> <span class="n">reg</span> <span class="k">in</span> <span class="n">gameObjectReg</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushstring</span> <span class="p">(</span><span class="n">luaState</span><span class="p">,</span> <span class="n">reg</span><span class="p">.</span><span class="n">funcName</span><span class="p">);</span>     <span class="c1">// set k</span>
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushcfunction</span> <span class="p">(</span><span class="n">luaState</span><span class="p">,</span> <span class="n">reg</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>   	<span class="c1">// set v = LuaCSFunction</span>
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_settable</span><span class="p">(</span><span class="n">luaState</span><span class="p">,</span> <span class="n">tableIdx</span><span class="p">);</span>			<span class="c1">// index of table on the stack</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>	
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_setglobal</span> <span class="p">(</span><span class="n">luaState</span><span class="p">,</span> <span class="s">&#34;GameObject&#34;</span><span class="p">);</span>	<span class="c1">// set to table</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">	[MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">gameObjectFind</span> <span class="p">(</span><span class="n">IntPtr</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">String</span> <span class="n">name</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_tostring</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">print</span> <span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">GameObject</span> <span class="n">o</span> <span class="p">=</span> <span class="n">GameObject</span><span class="p">.</span><span class="n">Find</span> <span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushnil</span> <span class="p">(</span><span class="n">L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// https://stackoverflow.com/questions/17339928/c-sharp-how-to-convert-object-to-intptr-and-back</span>
</span></span><span class="line"><span class="cl">		<span class="n">GCHandle</span> <span class="n">handle</span> <span class="p">=</span> <span class="n">GCHandle</span><span class="p">.</span><span class="n">Alloc</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">IntPtr</span> <span class="n">parameter</span> <span class="p">=</span> <span class="p">(</span><span class="n">IntPtr</span><span class="p">)</span> <span class="n">handle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// set metatable for userdate</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushlightuserdata</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">parameter</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">luaL_getmetatable</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;GameObject&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_setmetatable</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">print</span> <span class="p">(</span><span class="s">&#34;o=&#34;</span> <span class="p">+</span> <span class="n">o</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">print</span> <span class="p">(</span><span class="s">&#34;g=&#34;</span> <span class="p">+</span> <span class="n">parameter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//handle.Free();     //free it before Lua release it, but we don&#39;t known!</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">	[MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">gameObjectMove</span> <span class="p">(</span><span class="n">IntPtr</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">print</span> <span class="p">(</span><span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_gettop</span> <span class="p">(</span><span class="n">L</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="kt">float</span> <span class="n">z</span> <span class="p">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_tonumber</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">		<span class="kt">float</span> <span class="n">y</span> <span class="p">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_tonumber</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">2</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">		<span class="kt">float</span> <span class="n">x</span> <span class="p">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_tonumber</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">3</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">		<span class="n">IntPtr</span> <span class="n">parameter</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_touserdata</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">GCHandle</span> <span class="n">handle</span> <span class="p">=</span> <span class="p">(</span><span class="n">GCHandle</span><span class="p">)</span> <span class="n">parameter</span><span class="p">;</span>  <span class="c1">// convert to original object</span>
</span></span><span class="line"><span class="cl">		<span class="n">GameObject</span> <span class="n">o</span> <span class="p">=</span> <span class="n">handle</span><span class="p">.</span><span class="n">Target</span> <span class="k">as</span> <span class="n">GameObject</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">o</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector3</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="m">0</span><span class="p">;</span> <span class="c1">// non return value</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">	[MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">GetValue</span> <span class="p">(</span><span class="n">IntPtr</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">string</span> <span class="n">fname</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_tostring</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>        <span class="c1">// stack 2</span>
</span></span><span class="line"><span class="cl">		<span class="n">IntPtr</span> <span class="n">parameter</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_touserdata</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">2</span><span class="p">);</span>  <span class="c1">// stack 1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">print</span> <span class="p">(</span><span class="s">&#34;fname = &#34;</span> <span class="p">+</span> <span class="n">fname</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_getmetatable</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">2</span><span class="p">);</span>   <span class="c1">// meta stack 3  </span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushstring</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">fname</span><span class="p">);</span>  <span class="c1">// meta stack 4</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_rawget</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(!</span><span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_isnil</span> <span class="p">(</span><span class="n">L</span><span class="p">,-</span><span class="m">1</span><span class="p">))</span> <span class="p">{</span>    <span class="c1">// get from meta</span>
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_remove</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">2</span><span class="p">);</span>     <span class="c1">// remove metatable index</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="m">1</span><span class="p">;</span>			
</span></span><span class="line"><span class="cl">		<span class="p">}</span> 
</span></span><span class="line"><span class="cl">		<span class="c1">// not found in meta</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pop</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="m">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">GCHandle</span> <span class="n">handle</span> <span class="p">=</span> <span class="p">(</span><span class="n">GCHandle</span><span class="p">)</span> <span class="n">parameter</span><span class="p">;</span>  <span class="c1">// convert to original object</span>
</span></span><span class="line"><span class="cl">		<span class="n">GameObject</span> <span class="n">o</span> <span class="p">=</span> <span class="n">handle</span><span class="p">.</span><span class="n">Target</span> <span class="k">as</span> <span class="n">GameObject</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">fname</span> <span class="p">==</span> <span class="s">&#34;name&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushstring</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">o</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushnil</span> <span class="p">(</span><span class="n">L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">static</span> <span class="n">LuaL_Reg</span><span class="p">[]</span> <span class="n">gameObjectReg</span> <span class="p">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">new</span> <span class="n">LuaL_Reg</span> <span class="p">(</span> <span class="s">&#34;Find&#34;</span><span class="p">,</span>  <span class="n">gameObjectFind</span> <span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="k">new</span> <span class="n">LuaL_Reg</span> <span class="p">(</span> <span class="s">&#34;Move&#34;</span><span class="p">,</span>  <span class="n">gameObjectMove</span> <span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="k">new</span> <span class="n">LuaL_Reg</span> <span class="p">(</span> <span class="s">&#34;__index&#34;</span><span class="p">,</span>  <span class="n">GetValue</span> <span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//new LuaL_Reg ( &#34;__newindex&#34;,  SetValue ),</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">struct</span> <span class="nc">LuaL_Reg</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="kt">string</span> <span class="n">funcName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="n">LuaCSFunction</span> <span class="n">func</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="n">LuaL_Reg</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">LuaCSFunction</span> <span class="n">f</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">funcName</span> <span class="p">=</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">func</span> <span class="p">=</span> <span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>程序要点：</p>
<ul>
<li>RegisterGameObject 创建一个元表对象
<ul>
<li><strong>非表值的元表必须使用 luaL_newmetatable 创建元表</strong></li>
<li>添加该类的成员函数或你自定义的函数的静态封装， 如 gameObjectMove</li>
</ul>
</li>
<li>编写 Lua 对象生产函数
<ul>
<li>这里的案例是 gameObjectFind</li>
<li>第一步：处理参数，从左至右入栈</li>
<li>第二步：生产或使用已有游戏对象，转换 Object 到 Intptr
<ul>
<li>这里有一个潜在内存泄露点，GCHandle.Alloc 没有对应的 Free（关键是不能 Free）</li>
<li>注意，如果一个对象以 alloc 是否需要继续 alloc ？？？</li>
</ul>
</li>
<li>第三步：将句柄入栈为 userdata 并添加元表</li>
<li>第四步：将对象返回 Lua</li>
</ul>
</li>
<li>编写 Lua 对象成员函数
<ul>
<li>这里的案例  gameObjectMove</li>
<li>请先了解 <code>:</code> 语法糖的含义，因此栈底一定是 Lua 调用对象</li>
<li>第一步：处理参数，从左至右入栈</li>
<li>第二步：将 Lua 调用对象转为对应的 GameObject 实例</li>
<li>第三步：执行操作，返回参数</li>
</ul>
</li>
<li>编写元表的 <code>__index</code> 和 <code>__newindex</code>
<ul>
<li>这里的案例 GetValue，它实现了 <strong>对象属性访问</strong> 与 <strong>成员函数的调用</strong></li>
<li>如果没有 <code>__index</code> 元函数，Lua 对象将找不到它元表中的方法</li>
<li>第一步：处理参数，分别是 索引值、调用对象
<ul>
<li>索引值可能是字串、整数、或任意对象的值，一般只有前两种</li>
<li>调用对象只有可能是 userdata 或 table</li>
</ul>
</li>
<li>第二步：取调用对象的元表，检查是否有该成员。如存在，直接返回该成员值</li>
<li>第三步：如果是该对象属性，取值并返回，否则返回 nil 或设置 LuaError</li>
</ul>
</li>
<li>编写元表的 <code>__gc</code>
<ul>
<li>当 lua 垃圾收集启动，释放该对象时使用。 函数形式：<code>function gc_event (udata)</code></li>
<li>Free 为该 Lua 对象分配的 Handle。 如何编程？</li>
<li>注意：<strong>并没有销毁对象！</strong></li>
</ul>
</li>
</ul>
<p>其实编写上述程序非常困难，且 bug 很多，栈错误、栈中数据处理不当，都会导致游戏退出。不得不说，c# 托管对象节约了程序员很多时间，也不用太专注空间回收。好在这样的程序很有规律，可以用程序自动生成。</p>
<h2 id="7lua-集成技术小结">7、Lua 集成技术小结</h2>
<p>以上描述了 Lua 与 C# 交互的主要关键技术。但这样编程太艰难了！</p>
<p>事实上，好早就有人做好了这一切。早期，luanet.dll <a href="http://www.cnblogs.com/sifenkesi/p/3901831.html">工具</a>使用反射技术，实现了 C# 与 Lua 的无缝交互 。 以下是按时间组织的 Lua 与 Unity 交互的部分项目：</p>
<ul>
<li>LuaInterface (2004~2009) <a href="http://luaforge.net/projects/luainterface/">http://luaforge.net/projects/luainterface/</a></li>
<li>Lua for Windows (2008~2010) <a href="http://luaforge.net/projects/luaforwindows/">http://luaforge.net/projects/luaforwindows/</a></li>
<li>NLua (2009~2014) <a href="http://nlua.org/">http://nlua.org/</a> 或 <a href="https://github.com/NLua/NLua">https://github.com/NLua/NLua</a></li>
<li>CsToLua（2014.10~2015） <a href="https://github.com/topameng/CsToLua">https://github.com/topameng/CsToLua</a></li>
<li>ULua (2015~2016.3) <a href="http://ulua.org/">http://ulua.org/</a> 或 <a href="https://github.com/topameng/tolua">https://github.com/topameng/tolua</a></li>
<li>SLua (2015~2016) <a href="https://github.com/pangweiwei/slua">https://github.com/pangweiwei/slua</a></li>
</ul>
<p>如何选择开源项目?</p>
<ul>
<li>活跃度 ： 在 Github 上打开项目， 菜单 Insights -&gt; Contributors 看 Commits</li>
<li>成熟度 ： 分指数、release 数目</li>
</ul>
<p>按上述标准，ULua 和 Slua 都是可选的！</p>
<p>如何阅读修改源代码？</p>
<ul>
<li>从早期项目开始，如 CsToLua 作为起点，代码会简单一些。</li>
<li>然后，适当阅读一些博客</li>
</ul>
<p>本文仅讲述了脚本集成技术的基础，离实战有较多距离，但可以帮助你走好未来的路。</p>
<h2 id="8作业与练习">8、作业与练习</h2>
<p><strong>1、检查你的学习成果</strong></p>
<p>阅读以下博客</p>
<ul>
<li><a href="http://www.cnblogs.com/cqgreen/p/3483026.html">Unity3d中使用Lua</a>
<ul>
<li>这个程序有没有 bug，如有请指出并解决它！</li>
</ul>
</li>
<li><a href="http://www.cnblogs.com/zwywilliam/p/5999924.html">用好lua+unity，让性能飞起来——lua与c#交互篇</a>
<ul>
<li>阅读这样的文章是不错的，但它的观点都正确吗？保持批判性思维，以自己的实践为基础讨论问题。人云我云，道听途说，是做工程的大忌！</li>
<li>个人认为，让 lua GC 释放对象指针的 GCHanle 成本小，内存比较可控。 因此文中观点 2 在 Unity 中不一定成立，因为设计合理的游戏程序几乎不销毁游戏对象。</li>
<li>你都赞成作者3-4的观点吗？请阅读以下 lua 访问 C# 结构类型 的交互程序（Vector3），指出感觉性能被掏空的要点</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Runtime.InteropServices</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">SLua</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">class</span> <span class="nc">AccessStruct</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Use this for initialization</span>
</span></span><span class="line"><span class="cl">	<span class="k">void</span> <span class="n">Start</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">IntPtr</span> <span class="n">_L</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">luaL_newstate</span> <span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">luaL_openlibs</span><span class="p">(</span><span class="n">_L</span><span class="p">);</span>	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">RegisterVector3</span> <span class="p">(</span><span class="n">_L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_dostring</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="s">@&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">local v = Vector3.New()
</span></span></span><span class="line"><span class="cl"><span class="s">v.x = 3
</span></span></span><span class="line"><span class="cl"><span class="s">v.y = 4
</span></span></span><span class="line"><span class="cl"><span class="s">v1 = v.normalized
</span></span></span><span class="line"><span class="cl"><span class="s">collectgarbage()
</span></span></span><span class="line"><span class="cl"><span class="s">b = v1.x
</span></span></span><span class="line"><span class="cl"><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_getglobal</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="s">&#34;b&#34;</span><span class="p">);</span>       <span class="c1">// push the lua var on the stack</span>
</span></span><span class="line"><span class="cl">		<span class="n">print</span><span class="p">(</span><span class="s">&#34; watch trieved attribution name = &#34;</span><span class="p">+</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_tostring</span> <span class="p">(</span><span class="n">_L</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">));</span>  <span class="c1">// read return value</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pop</span><span class="p">(</span><span class="n">_L</span><span class="p">,</span><span class="m">1</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_close</span> <span class="p">(</span><span class="n">_L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">RegisterVector3</span> <span class="p">(</span><span class="n">IntPtr</span> <span class="n">luaState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">luaL_newmetatable</span> <span class="p">(</span><span class="n">luaState</span><span class="p">,</span> <span class="s">&#34;Vector3&#34;</span><span class="p">);</span>  	<span class="c1">//.Only metatable can be set to userdate</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">tableIdx</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_gettop</span><span class="p">(</span><span class="n">luaState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">foreach</span> <span class="p">(</span><span class="n">LuaL_Reg</span> <span class="n">reg</span> <span class="k">in</span> <span class="n">gameObjectReg</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushstring</span> <span class="p">(</span><span class="n">luaState</span><span class="p">,</span> <span class="n">reg</span><span class="p">.</span><span class="n">funcName</span><span class="p">);</span>     <span class="c1">// set k</span>
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushcfunction</span> <span class="p">(</span><span class="n">luaState</span><span class="p">,</span> <span class="n">reg</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>   	<span class="c1">// set v = LuaCSFunction</span>
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_settable</span><span class="p">(</span><span class="n">luaState</span><span class="p">,</span> <span class="n">tableIdx</span><span class="p">);</span>			<span class="c1">// index of table on the stack</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_setglobal</span> <span class="p">(</span><span class="n">luaState</span><span class="p">,</span> <span class="s">&#34;Vector3&#34;</span><span class="p">);</span>	<span class="c1">// set to table</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">	[MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">untiy_Vector3_New</span> <span class="p">(</span><span class="n">IntPtr</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//there are some bug here for checking parameters</span>
</span></span><span class="line"><span class="cl">		<span class="n">Vector3</span> <span class="n">v</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector3</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// https://msdn.microsoft.com/en-us/library/4ca6d5z7(v=vs.110).aspx</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Initialize unmanged memory to hold the struct.</span>
</span></span><span class="line"><span class="cl">		<span class="n">IntPtr</span> <span class="n">pnt</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="n">AllocHGlobal</span><span class="p">(</span><span class="n">Marshal</span><span class="p">.</span><span class="n">SizeOf</span><span class="p">(</span><span class="n">v</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Copy the struct to unmanaged memory.</span>
</span></span><span class="line"><span class="cl">		<span class="n">Marshal</span><span class="p">.</span><span class="n">StructureToPtr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pnt</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// set metatable for userdate</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushlightuserdata</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">pnt</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">luaL_getmetatable</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;Vector3&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_setmetatable</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">print</span> <span class="p">(</span><span class="s">&#34;v=&#34;</span> <span class="p">+</span> <span class="n">v</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">print</span> <span class="p">(</span><span class="s">&#34;pnt=&#34;</span> <span class="p">+</span> <span class="n">pnt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//free pnt before Lua release it, but we don&#39;t known!</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">	[MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">GetValue</span> <span class="p">(</span><span class="n">IntPtr</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">string</span> <span class="n">fname</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_tostring</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>        <span class="c1">// stack 2</span>
</span></span><span class="line"><span class="cl">		<span class="n">IntPtr</span> <span class="n">pnt</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_touserdata</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">2</span><span class="p">);</span>  <span class="c1">// stack 1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">print</span> <span class="p">(</span><span class="s">&#34;fname = &#34;</span> <span class="p">+</span> <span class="n">fname</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_getmetatable</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">2</span><span class="p">);</span>   <span class="c1">// meta stack 3  </span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushstring</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">fname</span><span class="p">);</span>  <span class="c1">// meta stack 4</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_rawget</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(!</span><span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_isnil</span> <span class="p">(</span><span class="n">L</span><span class="p">,-</span><span class="m">1</span><span class="p">))</span> <span class="p">{</span>    <span class="c1">// get from meta</span>
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_remove</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">2</span><span class="p">);</span>     <span class="c1">// remove metatable index</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="m">1</span><span class="p">;</span>			
</span></span><span class="line"><span class="cl">		<span class="p">}</span> 
</span></span><span class="line"><span class="cl">		<span class="c1">// not found in meta</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pop</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="m">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Create another Vector3 v.</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Set this Point to the value of the </span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Point in unmanaged memory. </span>
</span></span><span class="line"><span class="cl">		<span class="n">Vector3</span> <span class="n">v</span> <span class="p">=</span> <span class="p">(</span><span class="n">Vector3</span><span class="p">)</span><span class="n">Marshal</span><span class="p">.</span><span class="n">PtrToStructure</span><span class="p">(</span><span class="n">pnt</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Vector3</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">fname</span> <span class="p">==</span> <span class="s">&#34;x&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushnumber</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">fname</span> <span class="p">==</span> <span class="s">&#34;y&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushnumber</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">fname</span> <span class="p">==</span> <span class="s">&#34;z&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushnumber</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">fname</span> <span class="p">==</span> <span class="s">&#34;magnitude&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushnumber</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">magnitude</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">fname</span> <span class="p">==</span> <span class="s">&#34;normalized&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Vector3</span> <span class="n">v1</span> <span class="p">=</span> <span class="n">v</span><span class="p">.</span><span class="n">normalized</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">IntPtr</span> <span class="n">p1</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="n">AllocHGlobal</span><span class="p">(</span><span class="n">Marshal</span><span class="p">.</span><span class="n">SizeOf</span><span class="p">(</span><span class="n">v1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Copy the struct to unmanaged memory.</span>
</span></span><span class="line"><span class="cl">			<span class="n">Marshal</span><span class="p">.</span><span class="n">StructureToPtr</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// set metatable for userdate</span>
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushlightuserdata</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">p1</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">luaL_getmetatable</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;Vector3&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_setmetatable</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_pushnil</span> <span class="p">(</span><span class="n">L</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">	[MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">SetValue</span> <span class="p">(</span><span class="n">IntPtr</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//function(table, key, value)</span>
</span></span><span class="line"><span class="cl">		<span class="kt">string</span> <span class="n">fname</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_tostring</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">2</span><span class="p">);</span>        <span class="c1">// stack 2</span>
</span></span><span class="line"><span class="cl">		<span class="n">IntPtr</span> <span class="n">pnt</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_touserdata</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">3</span><span class="p">);</span>  <span class="c1">// stack 1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">print</span> <span class="p">(</span><span class="s">&#34;fname = &#34;</span> <span class="p">+</span> <span class="n">fname</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Create another Vector3 v.</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Set this Point to the value of the </span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Point in unmanaged memory. </span>
</span></span><span class="line"><span class="cl">		<span class="n">Vector3</span> <span class="n">v</span> <span class="p">=</span> <span class="p">(</span><span class="n">Vector3</span><span class="p">)</span><span class="n">Marshal</span><span class="p">.</span><span class="n">PtrToStructure</span><span class="p">(</span><span class="n">pnt</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Vector3</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">fname</span> <span class="p">==</span> <span class="s">&#34;x&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">v</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_tonumber</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> 
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">fname</span> <span class="p">==</span> <span class="s">&#34;y&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">v</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_tonumber</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">fname</span> <span class="p">==</span> <span class="s">&#34;z&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">v</span><span class="p">.</span><span class="n">z</span> <span class="p">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_tonumber</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Copy the struct to unmanaged memory.</span>
</span></span><span class="line"><span class="cl">		<span class="n">Marshal</span><span class="p">.</span><span class="n">StructureToPtr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pnt</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">	[MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">ReleaseUdata</span> <span class="p">(</span><span class="n">IntPtr</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">IntPtr</span> <span class="n">pnt</span> <span class="p">=</span> <span class="n">LuaDLL</span><span class="p">.</span><span class="n">lua_touserdata</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>        <span class="c1">// get user data</span>
</span></span><span class="line"><span class="cl">		<span class="n">print</span><span class="p">(</span><span class="s">&#34;release = &#34;</span> <span class="p">+</span> <span class="n">pnt</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">Marshal</span><span class="p">.</span><span class="n">FreeHGlobal</span><span class="p">(</span><span class="n">pnt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">static</span> <span class="n">LuaL_Reg</span><span class="p">[]</span> <span class="n">gameObjectReg</span> <span class="p">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">new</span> <span class="n">LuaL_Reg</span> <span class="p">(</span> <span class="s">&#34;New&#34;</span><span class="p">,</span>  <span class="n">untiy_Vector3_New</span> <span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="k">new</span> <span class="n">LuaL_Reg</span> <span class="p">(</span> <span class="s">&#34;__index&#34;</span><span class="p">,</span>  <span class="n">GetValue</span> <span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="k">new</span> <span class="n">LuaL_Reg</span> <span class="p">(</span> <span class="s">&#34;__newindex&#34;</span><span class="p">,</span>  <span class="n">SetValue</span> <span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="k">new</span> <span class="n">LuaL_Reg</span> <span class="p">(</span> <span class="s">&#34;__gc&#34;</span><span class="p">,</span>  <span class="n">ReleaseUdata</span> <span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>2、编程题</strong></p>
<p>用搜索引擎搜 “luacomponent”，在不使用 Ulua 或 SLua 高层封装条件下，用 lua 代码完成游戏对象的简单运动，
例如: 在 5 秒内，一个 Cube 从 (0,0,0) 匀速移动到 (3,4,0) 。</p>
<p>要求： 编写一个简单 luaComponent C# 代码，在 update 中调用一个 lua 表的中 <code>lua_update</code> 函数,  lua_update 会 调用 cube 对象的 SetPostion 方法。</p>
<h2 id="课后参考阅读">课后参考阅读</h2>
<ol>
<li><a href="https://book.douban.com/subject/26722255/">Lua游戏AI编程入门</a>  绝对是 NB 程序员必读！</li>
<li><a href="https://book.douban.com/subject/20392269/">Lua游戏开发实践指南</a>  Lua 游戏入门指南</li>
</ol>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">潘茂林</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2020-11-20
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E8%AF%BE%E4%BB%B6/">课件</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/13-multiplayer-and-networking/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">第13章、多人游戏与网络</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/08-particle-system/">
            <span class="next-text nav-default">八、粒子系统与流动效果</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:panml@mail.sysu.edu.cn" class="iconfont icon-email" title="email"></a>
  <a href="http://Thresh-Holden.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2018 - 
    2022
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">潘茂林</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.1c70606d1b733282f06230615f5561b5894924b6f9930ba2ab99cf1254f75a1a.js"></script>








</body>
</html>
